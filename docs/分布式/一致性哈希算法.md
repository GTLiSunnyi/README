# 一致性哈希算法
https://www.zsythink.net/archives/1182

## 1. 介绍
有3万条数据需要缓存到3台服务器中，并且要负载均衡。可以给每台服务器1万条数据。但是想要查找的时候就会很麻烦。hash(name) % num，name是数据名称，num是服务器数量。数据计算出什么结果就存在哪台服务器，这样查找的时候会少2/3的工作量。
问题：服务器数量发生变化时，数据就需要重新计算hash、重新分配。
解决：将服务器数量扩容两倍，会使得重新计算哈希的工作量最小。

## 2. 算法
服务器的位置：hash(ip) % 2^32
数据位置：         hash(name) % 2^32
数据会被存储在顺时针方向遇到的第一个服务器上
故障服务器上的数据会转移到顺时针下一个服务器上
优点：服务器出故障时，不会所有数据都在同一时间失效
![一致性哈希算法](../../images/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95.png)

## 3. 问题
hash环偏斜（服务器位置分布不均匀）
没有考虑到每台机器的性能不一样，不能很好实现负载均衡
解决：
虚拟节点。一般虚拟节点会比物理节点多很多

查询：服务器收到查询请求，先看在不在自己的节点上，不在的话将请求发给顺时针下一个服务器上。为了提高查询效率，服务器上需要维护一些路由信息，哪条信息在哪个服务器上。
