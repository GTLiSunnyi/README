# PBFT
[参考文档1 2020-5-2](https://blog.csdn.net/wuzhengfei1112/article/details/105890053/)  
[参考文档2 2019-11-21](https://zhuanlan.zhihu.com/p/93023831)

## 1. 简介
PBFT一般用于联盟链场景中，它是共识节点较少的情况下BFT的一种解决方案，PBFT 中的共识节点不宜超过100个，否则效率极低。 
- PBFT算法的计算效率依赖于参与协议的节点数量，由于每个副本节点都需要和其它节点进行P2P的共识同步，因此随着节点的增多，性能会下降的很快。 

PBFT 算法假设的环境又比 Raft 算法更加的’恶劣‘，Raft 算法只支持容错故障节点，而 PBFT 算法除了需要支持容错故障节点之外，还需要容忍作恶节点。

## 2. 容错率
节点总数是n，其中作恶节点有f，那么剩下的正确节点为n - f，意味着只要收到n - f个消息就能做出决定，但是这n - f个消息有可能有f个是由作恶节点冒充的，那么正确的消息就是n - f - f个，为了多数一致，正确消息必须占多数，也就是n - f - f > f，但是节点必须是整数个，所以n最少是3f+1个。

## 3. 角色设计
a. 客户端（c）：向 primary 发起请求的客户端节点。  
b. 主节点（primary）：将收到的请求排序、广播。  
c. 从节点/备份节点（replica，也称副本节点）：接收广播消息，验证请求合法性，投票。  
d. 视图（view）：一个 view 中存在一个主节点和多个副本节点，它描述了一个多副本系统的当前状态。另外，节点是在同一个 view 上对数据达成共识，不能跨域 view。  
e. 每个副本节点的状态都包含了服务的整体状态，副本节点上的消息日志(message log)包含了该副本节点接受(accepted)的消息，并且使用一个整数表示副本节点的当前视图编号（记作i）。

## 4. 三阶段
PBFT算法一致性的确保主要分为这三个阶段：预准备（pre-prepare）、准备(prepare)和确认(commit)。流程如下图所示（图中3为故障节点）：  
![三阶段](../../images/三阶段.png)


- Request：客户端C 发送请求到主节点0；
- Pre-Prepare：主节点0 收到 C 的请求后进行广播，扩散至123；
- Prepare：从节点123 收到后记录并再次广播，1->023，2->013，这一步是防止主节点给从节点发送不同的请求。
- Commit：节点0123 若收到超过 2F 的相同请求，则进入Commit阶段，广播Commit请求；
- Reply：若节点0123 其中有一个收到超过一定数量（2F+1）的相同请求，则执行请求，并对 C 进行反馈；
- C 收到 f+1 个相同请求，则完成三阶段。

> 为什么需要三阶段  
> https://codeantenna.com/a/BAgvJJje1g/
> 一阶段是主节点发送请求给从节点
> 二阶段是确认：从节点是在同一个版本下
> 三阶段执行具体的请求

## 5. view change
当主节点宕机后，client 会发送主节点宕机的信息给 backup 节点，backup 节点发起 view change，从节点对 view change 投票，如果超过 2/3，产生新的主节点。PBFT 系统内会维护一个 verison 号，主节点由 version % n 获得。
