# Layer2

## 1. 简介
“Layer1 来保证安全和去中心化，绝对可靠、可信；它能做到全球共识，并作为「加密法院」，通过智能合约设计的规则进行仲裁，以经济激励的形式将信任传递到 Layer2 上。而 Layer2 追求极致的性能，它只能做到局部共识，但是能够满足各类商业场景的需求。“ --ckb 的设计思想

## 2. 以太坊 L2 的进化路线：rollup 是阶段性的终点
以太坊的扩容路线有两条，一条是链上扩容，主要使用分片技术，是 ETH2.0 的目标之一。然而，分片的技术困难非常大，ETH 一开始目标是做1024个分片，后来发现太过困难，决定缩减至64个分片。但即使如此，现在离部署64个分片还有一段距离。所幸，以太坊的另一条扩容路线，也就是 Layer 2，已经做出了巨大突破，并且已经有不少项目落地，处在生态爆发前夕。

1. 最先被实现的 layer2 是状态通道 (State Channels)，它可以让两者在常数的 gas 开销下进行无数次交易，但其功用显然十分有限：用户每与一个人交易都需要建立一次链接，而且能做的操作非常有限。
2. 其次被实现的就是侧链(也有部分人认为侧链不算 L2)，简单来说就是开辟一条新的、可扩展性更好但是安全性更差的链帮助主链分担计算量。用户可以把一定资产转移到侧链，进行若干次交易之后，再转回主链。侧链的问题是，其安全性得不到保证。与主链相比，侧链缺乏足够的计算能力来维持共识，这就使侧链可能被矿工攻击。
3. 紧接着就是 rollup 方案。Rollup 大致的方法论是，把计算执行过程下放至链下，然后再用零知识证明/欺诈证明的方法，在链上证明正确性。

rollups 主要有四种:
Optimistic Rollups、Zk Rollup、Plasma 和 Validium / Zk porter。

- Plasma (欺诈证明+数据链下储存)
    > Plasma 的性能不高，并且交易数据存在链下，有很大的安全风险。

- Optimistic Rollups (欺诈证明+数据链上储存)
    > 开启 Optimistic Rollups 时，账户需要在 L1 中抵押代币。有一批交易需要上链时，需要相关账户对这批交易签名。交易会立刻在 L1 上执行，但是任何账户都可以对这些交易进行挑战，如果挑战成功，作恶者的押金会被扣除，挑战者会获得奖励。

    > 相应的，因为原始交易数据还是被打包上传至L1，原始交易数据的空间占用成为了性能瓶颈，Optimistic Rollups 的 TPS 会比 Plasma 低不少，但是依然大幅提升了以太坊的可扩展性。

    > 那么，Optimistic Rollups 是否有额外安全风险呢？欺诈证明使用经济学保证如果有合约的运行结果有误，那么就会有挑战者将其指出。也就是说，只要还有一个良性节点在检查交易结果，欺诈证明下的 Optimistic Rollups 的安全性就与 L1 相同。

- Validium / Zk porter (零知识证明+数据链下储存)
    > 零知识证明 (ZKP) 同时具备隐私性和扩展性。具备扩展性的原因是，验证零知识证明的正确性的速度远快于把整一套程序运行一遍以验证合约运行的正确性。

    > 与 Plasma 类似，为了提升可扩展性，智能合约将在链下运行，然后再把运行结果放回链上。不同于欺诈证明，Validium / Zk porter (这种技术没有统一名字，Validium 和 Zk porter 是实现这套技术的两个头部产品) 使用零知识证明来证明链下合约运行的正确性。链下节点除了要运行合约外，还需要额外构建一个零知识证明，并将之上传至链上，让 L1 验证零知识证明的正确性。构建一个零知识证明的计算量是较大的，但因为是链下运行，其成本相对来说较低。

    > 因为 Validium / Zk porter 的数据储存在链下，它也具有数据可用性存在风险的问题。如果链下提供原始交易数据的节点不再公开数据，而又没有其他节点保留了完整数据，那么 Validium / Zk porter 系统就会停运，因为没人可以恢复在 L2 上的活动数据，包括每个账户的余额。但 Validium / Zk porter 仍相对 Plasma 安全，因为用户的资金不会因为系统停运了而被盗。L2 停运了没有人可以获益，链下节点甚至会因为质押了“保证金”而蒙受损失，这可以减少恶意节点攻击 Validium / Zk porter 系统的几率。

- Zk Rollup (零知识证明+数据链上储存)
    > Zk Rollup 使用和 Validium / Zk porter 一样的零知识证明来保证合约运行的正确性，并且通过把压缩后的原始交易数据上传进不可篡改、无需许可的 L1 以解决 Validium / Zk porter 的数据可用性问题。和 Optimistic Rollups 不同的是，zk Rollup 的数据压缩率更高，因为原始交易的某些数据 (如交易签名) 可以被一起融入到本用于证明合约运行正确性的零知识证明中。更高的压缩率也使得 zk Rollup 的 TPS 比 Optimistic Rollups 快近一个数量级。 zk Rollup 使用数学和密码学的方式保证了合约运行的正确性，理论上保证了其安全性和 L1 相同。
    
    > 其问题在于:   
    > 1. 制造一个对零知识证明友好的 EVM (zkEVM) 在技术上有许多困难，这使得 zk Rollup 的落地速度会慢于 Optimistic Rollups；  
    > 2. 生成一个零知识证明 (ZKP) 需要成本，现今许多团队正在改进 zk 算法/硬件以减少生成 ZKP 的成本和增加其生成速度。尽管 zk Rollup 有这些问题，因为其更高的可扩展性、安全性和正统性，zkRollup 将成为主流。

[参考资料1 2022-06-15](https://mp.weixin.qq.com/s/z5BQXwdg-oiO8NHbRysclg)  
